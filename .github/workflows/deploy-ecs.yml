
name: Deploy to ECS (frontend + backend)

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY: saas-pm
  ECS_CLUSTER: saas-cluster

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [backend, frontend]
        include:
          - service: backend
            dockerfile: server/Dockerfile
            image_tag: backend-latest
            container_name: app                   # MUST match container name in backend task def
            task_def_path: infra/task-def-backend.json
            ecs_service: saas-backend-svc
            build_args: ""                        # no build-args for backend
          - service: frontend
            dockerfile: frontend/Dockerfile
            image_tag: frontend-latest
            container_name: nginx                 # MUST match container name in frontend task def
            task_def_path: infra/task-def-frontend.json
            ecs_service: saas-frontend-svc
            # בנה את הפרונט עם URL מלא ל-API (שים את זה ב-Repository secret בשם FRONTEND_API_URL)
            build_args: "--build-arg VITE_API_URL=${{ secrets.FRONTEND_API_URL }}"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::957597318409:role/gha-ecs-deploy-role
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build & Push ${{ matrix.service }} image
        env:
          REGISTRY: ${{ steps.ecr.outputs.registry }}
          REPO: ${{ env.ECR_REPOSITORY }}
          IMAGE_SHA: ${{ steps.ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ matrix.image_tag }}-${{ github.sha }}
          IMAGE_LATEST: ${{ steps.ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ matrix.image_tag }}
        run: |
          echo "Building ${{ matrix.service }} with Dockerfile: ${{ matrix.dockerfile }}"
          docker build -f ${{ matrix.dockerfile }} ${{ matrix.build_args }} -t "$IMAGE_SHA" .
          docker tag "$IMAGE_SHA" "$IMAGE_LATEST"
          docker push "$IMAGE_SHA"
          docker push "$IMAGE_LATEST"
          echo "IMAGE_URI=$IMAGE_SHA" >> "$GITHUB_ENV"

      - name: Render ${{ matrix.service }} task definition
        id: taskdef
        uses: aws-actions/amazon-ecs-render-task-definition@v1
        with:
          task-definition: ${{ matrix.task_def_path }}
          container-name: ${{ matrix.container_name }}
          image: ${{ env.IMAGE_URI }}

      - name: Deploy ${{ matrix.service }} to ECS Service
        uses: aws-actions/amazon-ecs-deploy-task-definition@v2
        with:
          task-definition: ${{ steps.taskdef.outputs.task-definition }}
          service: ${{ matrix.ecs_service }}
          cluster: ${{ env.ECS_CLUSTER }}
          wait-for-service-stability: true
